---
title: ""
author: "Rodrigo Arcoverde Cerveira"
date: '`r format(Sys.Date(), "%Y-%m-%d")`'
output: html_document
abstract: Short project description.
knit: (function(inputFile, encoding) {
          rmarkdown::render(inputFile,
                            encoding = encoding, 
                            output_file = paste0(
                              xfun::sans_ext(inputFile), '_', Sys.Date(), '.html'),
                                output_dir = "../results/lab_book/")})
---

```{r setup, include=FALSE}
knitr::opts_knit$set(echo = TRUE,
                     root.dir = getwd(),
                     fig.width = 6, fig.height = 5,
                     warning = FALSE, 
                     message = FALSE)

result.dir <- paste0("results/",Sys.Date(),"/")

## creates result.dir with date in if not existent
ifelse(isFALSE(dir.exists(paste0("../",result.dir))), dir.create(paste0("../",result.dir),recursive = TRUE),"Result directory for today exists already!")
options(stringsAsFactors = FALSE) 
```

## Needed libraries
```{r libraries, message=FALSE}
library(data.table)
library(ggplot2)
library(dplyr)
library(tidyr)
library(cowplot)
library(stringr)
library(ggtree)
library(treeio)
library(seqRFLP)
library(Biostrings)
library(msa)
library(treeio)

```

## Load data
```{r message=FALSE, warning=FALSE, echo=FALSE}
#binding summary tables
ls <- list.files("~/Box Sync/public_repertoire/results/2020-09-13/public-tables", full.names = T)
ls <- grep("summary", ls, value = T)
df <- lapply(ls, read.csv)
names(df) <- c("B1", "B2", "PV")
df <- rbindlist(df, idcol = T)


#combining animals
rem_dup.one <- function(x){
  paste(unique(toupper(trimws(unlist(strsplit(x,split="(?!')[ [:punct:]]",fixed=F,perl=T))))),collapse = ", ")
}
rem_dup.vector <- Vectorize(rem_dup.one,USE.NAMES = F)

df_f <-  df %>% 
  mutate(combined_animals = paste0(animals_rep_seq, sep = ", ", animals_sc)) 

df_f$combined_animals <- rem_dup.vector(df_f$combined_animals)
df_f$combined_animals <- gsub(", , ", ", ",df_f$combined_animals)
df_f$.id <- gsub("IgM", "PV", df_f$.id)
df_f$sequence <- sub("+", "",df_f$sequence)
df_comb <- df_f %>% mutate(number_animals_combined = str_count(combined_animals, "E"))
groups <- data.frame(NP = c("E11", "E16", "E17", "E23", "E24"),
                     SOL = c("E12", "E14", "E18", "E21", NA))
ff = function(x, patterns, replacements = patterns, fill = NA, ...)
{
  stopifnot(length(patterns) == length(replacements))
  
  ans = rep_len(as.character(fill), length(x))    
  empty = seq_along(x)
  
  for(i in seq_along(patterns)) {
    greps = grepl(patterns[[i]], x[empty], ...)
    ans[empty[greps]] = replacements[[i]]  
    empty = empty[!greps]
  }
  
  return(ans)
}
df_comb$NP <- ff(df_comb$combined_animals, 
                     patterns = c("E11", "E16", "E17", "E23", "E24"), 
                     replacements = c("NP","NP","NP","NP","NP"))
df_comb$SOL <- ff(df_comb$combined_animals, 
                  patterns = c("E12", "E14", "E18", "E21"), 
                  replacements = c("SOL","SOL","SOL","SOL"))

df_comb <- df_comb %>%
  mutate(Groups = ifelse(!is.na(df_comb$NP) & !is.na(df_comb$SOL),
                         "Both",
                         ifelse(!is.na(df_comb$NP) & is.na(df_comb$SOL),
                                "NP",
                                ifelse(is.na(df_comb$NP) & !is.na(df_comb$SOL),
                                       "SOL", ""))))
filtered <- df_comb %>% filter(number_animals_combined >= 2)


```



```{r data_prep}
#function to create clonoquery file first
.clono_full <- function(z){
ls <- list.files(z, full.names = T)
ls <- grep("full.txt", ls, value = T)
print(ls)
  if(length(ls) != 9) {
    stop("Folder not containing 9 files, please check the number of files or change the function to allow a different number of files.")
  }
  if(any(!grepl("full",ls))){
    stop("Files in the folder are not identified as a full file in its name.")
  }
  else{
    x <- lapply(ls, fread, fill = T)
    names(x) <- c("E11", "E12", "E14", "E16", "E17", "E18", "E21", "E23", "E24")
    x <- lapply(x, function (x) x[!apply(is.na(x) | x == "", 1, all),])       
    x_all <- do.call(rbind, x)
#getting the clonoquery named properly, all clones queries, aka full table
    x_m_full <- x_all %>% 
      mutate(grp = cumsum(grepl("Query",name))) %>%
      group_by(grp) %>% 
      mutate(clonoquery = ifelse(row_number() > 1, dplyr::first(name), name)) %>%
      ungroup() %>% 
      select(-c(grp)) %>%
      relocate(clonoquery) %>%
      mutate(clone = substr(clonoquery, 10,14))
    }
return(x_m_full)
}

###### COMBINING CLONOQUERY FULL v4_NGS TR1 #######
clonoquery_full_B2 <- .clono_full(
  "~/Box Sync/RSV NGS/v4_Analysis/v4_public-repertoire/analysis/v4/results/2020-09-13/clonoquery/B2")

###### COMBINING CLONOQUERY FULL v4_B1-D14 #######
clonoquery_full_B1 <- .clono_full(
  "~/Box Sync/RSV NGS/v4_Analysis/v4_public-repertoire/analysis/v4/results/2020-09-13/clonoquery/B1")

###### COMBINING CLONOQUERY FULL igM #######
clonoquery_full_igm <- .clono_full(
  "~/Box Sync/RSV NGS/v4_Analysis/v4_public-repertoire/analysis/v4/results/2020-09-13/clonoquery/IgM/")

##### Combining all the clonoquery full files into a single file #######
## output as CSV file with a new column for time_point

combined_full <- list(clonoquery_full_igm, clonoquery_full_B1, clonoquery_full_B2)
names(combined_full) <- c("PV", "B1", "B2") 
combined_full  <- rbindlist(combined_full, idcol = T, fill = T)  
combined_full  <- combined_full %>% rename(time_point = .id) %>% filter(count > 0)

filtered_np <- merge(filtered, combined_full, by = "clone")
filtered_np <- filtered_np %>%
  mutate(E11_and_E16 = ifelse(grepl("^E11, E16$",combined_animals),"YES", "NO"))
filtered$clone %in% combined_full$clone

```

```{r plot_4, eval=FALSE}
set.seed(50)
filtered_to_fasta <- filtered_np %>% group_by(clone) %>% sample_n(size = 1) %>% select(clone,VDJ_nt, VDJ_aa, .id)

filtered_to_fasta_nt <- filtered_to_fasta %>% select(clone,VDJ_nt) %>% as.data.frame()

filtered_to_fasta_aa <- filtered_to_fasta %>% select(clone,VDJ_aa) %>% as.data.frame()


dataframe2fas(filtered_to_fasta_nt, "~/Box Sync/public_repertoire/results/2020-10-05/public-clones_nt.fasta")
dataframe2fas(filtered_to_fasta_aa, "~/Box Sync/public_repertoire/results/2020-10-05/public-clones_aa.fasta")


p_nt <- readBStringSet("~/Box Sync/public_repertoire/results/2020-10-05/public-clones_nt.fasta")
p_aa <- readBStringSet("~/Box Sync/public_repertoire/results/2020-10-05/public-clones_aa.fasta")

p_nt_msa <- msaMuscle(p_nt, verbose = T, type = "dna")
p_aa_msa <- msaMuscle(p_aa, verbose = T, type = "protein")

writeXStringSet(BStringSet(p_nt_msa), 
                "~/Box Sync/public_repertoire/results/2020-10-05/public-clones_nt_msa.fasta")
writeXStringSet(BStringSet(p_aa_msa), 
                "~/Box Sync/public_repertoire/results/2020-10-05/public-clones_aa_msa.fasta")
```

```{r ploting_tree}
t1 <- treeio::read.tree(
  "~/Box Sync/public_repertoire/results/2020-10-05/nt_fastree_result.tre")
str(t1)
t2 <- ggtree(t1) +  geom_treescale(width = 0.1) + geom_tiplab(color = "firebrick") + 
  geom_rootedge()


```

## SessionInfo
```{r}
sessionInfo()
```

